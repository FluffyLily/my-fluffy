<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.renee328.mapper.BbsCategoryMapper">

    <!-- 모든 게시판 카테고리 조회 -->
    <select id="selectAllCategories" resultType="com.renee328.dto.BbsCategoryDto">
        SELECT BOARD_CATEGORY_ID, BOARD_CATEGORY_NAME
        FROM bbs_category ORDER BY BOARD_CATEGORY_ID
    </select>

    <!-- 카테고리 상세 조회 -->
    <select id="selectCategoryByCategoryId" parameterType="java.lang.Long" resultType="com.renee328.dto.BbsCategoryDto">
        SELECT * FROM bbs_category
        WHERE BOARD_CATEGORY_ID = #{boardCategoryId}
    </select>

    <!-- 게시판별 카테고리 조회 -->
    <select id="selectCategoriesByBoardId" parameterType="java.lang.Long" resultType="com.renee328.dto.BbsCategoryDto">
        SELECT
            category.BOARD_CATEGORY_ID,
            category.BOARD_CATEGORY_NAME
        FROM
            bbs_category_mapping mapping
        INNER JOIN bbs_category category ON mapping.BOARD_CATEGORY_ID = category.BOARD_CATEGORY_ID
        WHERE
            mapping.BOARD_ID = #{boardId}
        ORDER BY
            category.BOARD_CATEGORY_ID
    </select>

    <!-- 카테고리 이름 조회 -->
    <select id="findCategoryNameById" parameterType="java.lang.Long" resultType="String">
        SELECT BOARD_CATEGORY_NAME FROM bbs_category WHERE BOARD_CATEGORY_ID = #{boardCategoryId}
    </select>

    <!-- 게시판 카테고리에 속한 게시판 수 -->
    <select id="countBoardByCategoryId" parameterType="long" resultType="int">
        SELECT COUNT(*) FROM bbs_category_mapping WHERE BOARD_CATEGORY_ID = #{boardCategoryId}
    </select>

    <!-- 게시판 카테고리 추가 -->
    <insert id="insertCategory" parameterType="com.renee328.dto.BbsCategoryDto" useGeneratedKeys="true" keyProperty="boardCategoryId" keyColumn="BOARD_CATEGORY_ID">
        INSERT INTO bbs_category (BOARD_CATEGORY_NAME, CREATED_AT, CREATED_BY, UPDATED_AT, UPDATED_BY)
        VALUES (#{boardCategoryName}, NOW(), #{createdBy}, NOW(), #{updatedBy})
    </insert>

    <!-- 게시판과 카테고리 매핑 추가 -->
    <insert id="insertCategoryMapping" parameterType="map">
        INSERT INTO bbs_category_mapping (BOARD_ID, BOARD_CATEGORY_ID)
        VALUES (#{boardId}, #{boardCategoryId})
    </insert>

    <!-- 게시판 카테고리 수정 -->
    <update id="updateCategory" parameterType="com.renee328.dto.BbsCategoryDto">
        UPDATE bbs_category
        SET
            BOARD_CATEGORY_NAME = #{boardCategoryName},
            UPDATED_AT = NOW(),
            UPDATED_BY = #{updatedBy}
        WHERE
            BOARD_CATEGORY_ID = #{boardCategoryId}
    </update>

    <!-- 게시판 카테고리 삭제 -->
    <delete id="deleteCategory" parameterType="java.lang.Long">
        DELETE FROM bbs_category
        WHERE BOARD_CATEGORY_ID = #{boardCategoryId}
    </delete>

    <!-- 게시판과 카테고리 매핑 삭제 -->
    <delete id="deleteCategoryMapping" parameterType="java.lang.Long">
        DELETE FROM bbs_category_mapping
        WHERE BOARD_ID = #{boardId}
    </delete>

    <!-- 게시판 카테고리 삭제 로그 -->
    <insert id="logBbsCategoryDeletion" parameterType="map">
        INSERT INTO admin_action_logs (ADMIN_ID, ACTION, TARGET, TIMESTAMP)
        VALUES (#{deleterId}, '게시판 카테고리 삭제', #{boardCategoryName}, NOW())
    </insert>
</mapper>