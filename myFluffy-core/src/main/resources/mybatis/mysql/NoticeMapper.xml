<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.renee328.mapper.NoticeMapper">

    <resultMap id="noticeResultMap" type="com.renee328.dto.NoticeDto">
        <id property="noticeId" column="NOTICE_ID"/>
        <result property="title" column="TITLE"/>
        <result property="content" column="CONTENT"/>
        <result property="isActive" column="IS_ACTIVE" javaType="boolean"/>
        <result property="createdBy" column="CREATED_BY"/>
        <result property="createdByName" column="CREATED_BY_NAME"/>
        <result property="createdAt" column="CREATED_AT"/>
        <result property="updatedBy" column="UPDATED_BY"/>
        <result property="updatedByName" column="UPDATED_BY_NAME"/>
        <result property="updatedAt" column="UPDATED_AT"/>
    </resultMap>

    <!-- 공통 검색 조건 -->
    <sql id="commonSearchCondition">
        <if test="searchKeyword != null and searchKeyword != ''">
            AND (TITLE LIKE CONCAT('%', #{searchKeyword}, '%')
            OR CONTENT LIKE CONCAT('%', #{searchKeyword}, '%'))
        </if>
    </sql>

    <!-- 시스템 공지 목록 조회 -->
    <select id="findActiveNotices" parameterType="com.renee328.dto.PostSearchCondition" resultMap="noticeResultMap">
        SELECT NOTICE_ID, TITLE, CONTENT, IS_ACTIVE, CREATED_BY, CREATED_BY_NAME, CREATED_AT, UPDATED_BY, UPDATED_BY_NAME, UPDATED_BY
        FROM notices
        WHERE 1 = 1
        <include refid="commonSearchCondition" />
        <choose>
            <when test="sort.value == 'recent'">
                ORDER BY CREATED_AT DESC
            </when>
            <when test="sort.value == 'old'">
                ORDER BY CREATED_AT ASC
            </when>
        </choose>
        <if test="limit != null and offset != null">
            LIMIT #{limit} OFFSET #{offset}
        </if>
    </select>

    <!-- 시스템 공지 개수 조회 -->
    <select id="getNoticesCount" parameterType="com.renee328.dto.PostSearchCondition" resultType="int">
        SELECT COUNT(*)
        FROM notices
        WHERE 1 = 1
        <include refid="commonSearchCondition" />
    </select>

    <!-- 대시보드 최신 공지 조회 -->
    <select id="getRecentNotice" resultType="com.renee328.dto.NoticeDto">
        SELECT TITLE, CONTENT, CREATED_AT FROM notices
        WHERE IS_ACTIVE = 1
        ORDER BY CREATED_AT DESC
        LIMIT 1
    </select>

    <!-- 시스템 세부 내용 조회 -->
    <select id="getNoticeDetails" parameterType="java.lang.Long" resultMap="noticeResultMap">
        SELECT TITLE, CONTENT, IS_ACTIVE,
               CREATED_BY, CREATED_BY_NAME, CREATED_AT,
               UPDATED_BY, UPDATED_BY_NAME, UPDATED_AT
        FROM notices
        WHERE NOTICE_ID = #{noticeId}
    </select>

    <!-- 시스템 공지 생성 -->
    <insert id="insertNotice" parameterType="com.renee328.dto.NoticeDto" useGeneratedKeys="true" keyProperty="noticeId" keyColumn="NOTICE_ID">
        INSERT INTO notices (TITLE, CONTENT, IS_ACTIVE, CREATED_BY, CREATED_BY_NAME, CREATED_AT)
        VALUES (#{title}, #{content}, #{isActive}, #{createdBy}, #{createdByName}, NOW())
    </insert>

    <!-- 시스템 공지 수정 -->
    <update id="updateNotice" parameterType="com.renee328.dto.NoticeDto">
        UPDATE notices
        SET TITLE = #{title},
            CONTENT = #{content},
            IS_ACTIVE = #{isActive},
            UPDATED_BY = #{updatedBy},
            UPDATED_BY_NAME = #{updatedByName},
            UPDATED_AT = NOW()
        WHERE NOTICE_ID = #{noticeId}
    </update>

    <!-- 시스템 공지 삭제 -->
    <update id="deleteNotice" parameterType="java.lang.Long">
        DELETE FROM notices WHERE NOTICE_ID = #{noticeId}
    </update>

    <!-- 시스템 공지 삭제 로그 -->
    <insert id="logNoticeDeletion" parameterType="map">
        INSERT INTO admin_action_logs (ADMIN_ID, ACTION, TARGET, TIMESTAMP)
        VALUES (#{deleterId}, '시스템 공지 삭제', #{title}, NOW())
    </insert>

</mapper>